<html>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.9.4/chartist.min.css">
<head>
<body>

<div class="container">

    <h1 style="font-size: 210%", id="title">Zayo / Big Data: Business Intelligience Collaboration
        <div class="authors">by Karen Blakemore, Fadhil Suhendi & Zhili Yang</div>
      </h1>

    <section id="q1" class="question">
        <h4 style="font-size: 150%">1. What is the relationship between product and bandwidth, for top 15 bandwidths (10G, DS1, DS3, 50Mb, 30Mb, 1G, 1000Mb, Fiber Pair, 5Mb, Bulk Fiber, 1.5G, 4G, 2.5G, 100Mb, 400Mb)</h4>
        <div style="height:300px", class="answer ct-double-octave"></div>
    </section>

    <section id="q2" class="question">
        <h4 style="font-size: 150%">2. Fadhil's question </h4>
        <div class="answer ct-double-octave"></div>
    </section>

    <section id="q3" class="question">
        <h4 style="font-size: 150%">3. What are the relationships between industries and products?</h4>
        <div class="answer ct-double-octave"></div>
    </section>

</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.9.4/chartist.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
    <script>

var profileItems = []
var servicesItems = []

// What is the relationship between product and bandwidth?
function solution1() {
    productsByBandwidth = _.chain(servicesItems)
        .filter(function(s) { return !_.includes(['NA', 'N/A', 'NULL'], s.Bandwidth) })
        .groupBy('Bandwidth')
        .mapValues(function(b) {
            return _.chain(b)
                .groupBy('Product')
                .mapValues('length')
                .defaults({'Other': 0}, {'Product A': 0}, {'Product B': 0}, {'Product C': 0}, {'Product D': 0}, 
                    {'Product E': 0}, {'Product F': 0})
                .pairs()
                .unzip()
                .value()[1]        
        })
        .value()

    serviceCounts = _.slice(_.values(productsByBandwidth), 0, 15)
    bandwidths = _.keys(productsByBandwidth)
    console.log('counts', serviceCounts)
    console.log('bandwidths', bandwidths)

    data = { 
        labels: ['Other', 'Product A', 'Product B', 'Product C', 'Product D', 'Product E', 'Product F'],
        series: serviceCounts
    }

    options = { 
        stackBars: true,
        horizontalBars: true
    }

    new Chartist.Bar('#q1 .answer', data, options)
        .on('draw', function(data) {
            if(data.type === 'bar') {
                data.element.attr({ style: 'stroke-width: 30px' })
            }
        })
}

function solution2(){
    return 'TBD'
}

// 3. What are the relationships between industries and products?
function solution3(){
  	return 'TBD'
}

function run(id, solutionFunc){
    console.log('run solution for ' + id)
    var answer = solutionFunc()
    $(id).find('.answer').html(answer)
}

function tsv2jsonProfile(rawdata){
  var lines = rawdata.trim().split('\n')
  var rows = _.rest(lines)
  var row2 = _.drop(rows,4)
  return _.map(row2, function(row){
    var toks = row.split('\t')
    return {"ID/Name": toks[0], "Industry": toks[1], "Vertical": toks[2], "Total (BRR)": toks[3],"Product A Rank":toks[4],"Product A Total BRR":toks[5],"Product B Rank":toks[6],"Product B Total BRR":toks[7],"Product C Rank":toks[8],"Product C Total BRR":toks[9],"Product D Rank":toks[10],"Product D Total BRR":toks[11],"Product E Rank":toks[12],"Product F - Metro Rank":toks[13]} 
  })
}

function tsv2jsonServices(rawdata){
  var lines = rawdata.trim().split('\n')
  var rows = _.rest(lines)
  rows=_.drop(rows, 7)
  return _.map(rows, function(row){
    var toks = row.split('\t')
    return {"ID/Name": toks[0], "Service Count": toks[1], "Service ID": toks[2], "Product": toks[3], "Total MRR": toks[4], "Term": toks[5], "Bandwidth": toks[6], "State A": toks[7], "State Z": toks[8]}
  })
}

function loadDataThenRunSolutions() {
  $.get('http://kjblakemore.github.io/book3/data/customer_accounts_profile.tsv')
    .done(function(data){ console.log('got profile data 2')   
      profileItems = tsv2jsonProfile(data)
      console.log('profileItems[0]', profileItems[0])
    $.get('http://kjblakemore.github.io/book3/data/customer_accounts_services.tsv')
      .done(function(data){
        servicesItems = tsv2jsonServices(data)
        console.log('servicesItems[0]', servicesItems[0])

        run('#q1', solution1)
        run('#q2', solution2)
        run('#q3', solution3)
      })
  })
  .fail(function(err){
    console.error(err)
  })
}

loadDataThenRunSolutions()

    </script>

</body>
</html>
